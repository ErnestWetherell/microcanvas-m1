{% extends "base.html" %}

{% block content %}
  <h1>{{ course.code }} — {{ course.title }}</h1>

  {% if current_user.is_instructor %}
    <p>
      <a href="{{ url_for('main.new_task', course_id=course.id) }}">
        + New Task / Assignment
      </a>
    </p>
  {% endif %}

  <section class="card">
    <h2>Task board</h2>
    <div class="board-grid">
      {% for column in status_columns %}
        <div class="board-column">
          <h3>{{ column.label }}</h3>
          {% if column.tasks %}
            {% for task in column.tasks %}
              <article class="task-card">
                <header>
                  <strong>{{ task.title }}</strong>
                  <span class="task-points">{{ task.points }} pts</span>
                </header>
                {% if task.description %}
                  <p>{{ task.description }}</p>
                {% endif %}
                {% if task.due_date %}
                  <p class="task-meta">Due {{ task.due_date.strftime("%b %d") }}</p>
                {% endif %}
                {% if task.team %}
                  <p class="task-meta">Team: {{ task.team.name }}</p>
                {% endif %}
                {% if task.score is not none %}
                  <p class="task-meta">Score: {{ task.score }}</p>
                {% endif %}
                <form method="post" action="{{ url_for('main.update_task_status', task_id=task.id) }}" class="status-form">
                  {{ status_form.csrf_token }}
                  <label class="sr-only" for="status-{{ task.id }}">Status</label>
                  <select id="status-{{ task.id }}" name="status">
                    {% for value, label in status_choices %}
                      <option value="{{ value }}" {% if value == task.status %}selected{% endif %}>
                        {{ label }}
                      </option>
                    {% endfor %}
                  </select>
                  <button type="submit">Update</button>
                </form>
                {% if current_user.is_instructor %}
                  <a class="text-link" href="{{ url_for('main.grade_task', task_id=task.id) }}">Grade</a>
                {% endif %}
                {% if task.comments %}
                  <div class="task-comments">
                    <strong>Feedback</strong>
                    <ul>
                      {% for comment in task.comments %}
                        <li>
                          <span class="comment-author">{{ comment.author.email }}</span>
                          <small>{{ comment.created_at.strftime("%b %d %H:%M") }}</small>
                          <p>{{ comment.body }}</p>
                        </li>
                      {% endfor %}
                    </ul>
                  </div>
                {% endif %}
                {% if current_user.can_review_tasks %}
                  <form method="post" action="{{ url_for('main.add_task_comment', task_id=task.id) }}" class="comment-form">
                    {{ comment_form.csrf_token }}
                    {{ comment_form.body(id='comment-body-' ~ task.id, rows=2, placeholder='Leave quick feedback...') }}
                    <button type="submit">Post</button>
                  </form>
                {% endif %}
              </article>
            {% endfor %}
          {% else %}
            <p class="empty-state">No tasks.</p>
          {% endif %}
        </div>
      {% endfor %}
    </div>
  </section>

  <section class="card">
    <h2>Teams</h2>
    {% if teams %}
      <ul>
        {% for team in teams %}
          <li>
            <a href="{{ url_for('main.team_detail', team_id=team.id) }}">{{ team.name }}</a>
            — {{ team.memberships|length }} members
            {% if team.memberships %}
              <br>
              <small>
                {% for member in team.memberships %}
                  {{ member.user.email }}{% if not loop.last %}, {% endif %}
                {% endfor %}
              </small>
            {% endif %}
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p>No teams yet.</p>
    {% endif %}

    {% if current_user.is_instructor %}
      <h3>Create a new team</h3>
      <form method="post" action="{{ url_for('main.create_team', course_id=course.id) }}">
        {{ team_form.hidden_tag() }}
        {{ team_form.name(size=30) }}
        {{ team_form.submit() }}
      </form>
    {% endif %}
  </section>
{% endblock %}
