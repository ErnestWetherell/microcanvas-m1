{% extends "base.html" %}

{% block content %}
  <h1>{{ course.code }} — {{ course.title }}</h1>

  {% if current_user.is_instructor %}
    <p>
      <a href="{{ url_for('main.new_task', course_id=course.id) }}">
        + New Task / Assignment
      </a>
    </p>
  {% endif %}

  <div style="display: flex; gap: 2rem; flex-wrap: wrap;">
    <div>
      <h2>To Do</h2>
      {% if tasks_todo %}
        <ul>
          {% for t in tasks_todo %}
            <li>
              <strong>{{ t.title }}</strong> ({{ t.points }} pts)
              {% if current_user.is_authenticated %}
                <a href="{{ url_for('main.toggle_task', task_id=t.id) }}">
                  Mark done
                </a>
              {% endif %}
              {% if current_user.is_instructor %}
                | <a href="{{ url_for('main.grade_task', task_id=t.id) }}">Grade</a>
              {% endif %}
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p>No tasks.</p>
      {% endif %}
    </div>

    <div>
      <h2>In Progress</h2>
      {% if tasks_in_progress %}
        <ul>
          {% for t in tasks_in_progress %}
            <li>
              <strong>{{ t.title }}</strong> ({{ t.points }} pts)
              {% if current_user.is_authenticated %}
                <a href="{{ url_for('main.toggle_task', task_id=t.id) }}">
                  Mark done
                </a>
              {% endif %}
              {% if current_user.is_instructor %}
                | <a href="{{ url_for('main.grade_task', task_id=t.id) }}">Grade</a>
              {% endif %}
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p>No tasks.</p>
      {% endif %}
    </div>

    <div>
      <h2>Done</h2>
      {% if tasks_done %}
        <ul>
          {% for t in tasks_done %}
            <li>
              <strong>{{ t.title }}</strong> ({{ t.points }} pts)
              {% if t.score is not none %}
                — score: {{ t.score }}
              {% else %}
                — not graded
              {% endif %}
              {% if current_user.is_authenticated %}
                <a href="{{ url_for('main.toggle_task', task_id=t.id) }}">
                  Reopen
                </a>
              {% endif %}
              {% if current_user.is_instructor %}
                | <a href="{{ url_for('main.grade_task', task_id=t.id) }}">Grade</a>
              {% endif %}
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p>No tasks.</p>
      {% endif %}
    </div>
  </div>

  <section class="card">
    <h2>Teams</h2>
    {% if teams %}
      <ul>
        {% for team in teams %}
          <li>
            <a href="{{ url_for('main.team_detail', team_id=team.id) }}">{{ team.name }}</a>
            — {{ team.memberships|length }} members
            {% if team.memberships %}
              <br>
              <small>
                {% for member in team.memberships %}
                  {{ member.user.email }}{% if not loop.last %}, {% endif %}
                {% endfor %}
              </small>
            {% endif %}
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p>No teams yet.</p>
    {% endif %}

    {% if current_user.is_instructor %}
      <h3>Create a new team</h3>
      <form method="post" action="{{ url_for('main.create_team', course_id=course.id) }}">
        {{ team_form.hidden_tag() }}
        {{ team_form.name(size=30) }}
        {{ team_form.submit() }}
      </form>
    {% endif %}
  </section>
{% endblock %}
