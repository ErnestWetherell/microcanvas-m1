{% extends "base.html" %}

{% block content %}
  <h1>{{ team.name }}</h1>
  <p>Course: <a href="{{ url_for('main.course_detail', course_id=team.course.id) }}">{{ team.course.code }} â€” {{ team.course.title }}</a></p>

  <section class="card">
    <h2>Members</h2>
    {% if team.memberships %}
      <ul>
        {% for membership in team.memberships %}
          <li>{{ membership.user.email }}</li>
        {% endfor %}
      </ul>
    {% else %}
      <p>No members yet.</p>
    {% endif %}

    {% if current_user.is_instructor %}
      {% if member_form.user_id.choices %}
        <form method="post" action="{{ url_for('main.add_team_member', team_id=team.id) }}">
          {{ member_form.hidden_tag() }}
          {{ member_form.user_id() }}
          {{ member_form.submit() }}
        </form>
      {% else %}
        <p>All students in this course already belong to a team.</p>
      {% endif %}
    {% endif %}
  </section>

  <section class="card">
    <h2>Team tasks</h2>
    <div class="board-grid">
      {% for column in status_columns %}
        <div class="board-column">
          <h3>{{ column.label }}</h3>
          {% if column.tasks %}
            {% for task in column.tasks %}
              <article class="task-card">
                <header>
                  <strong>{{ task.title }}</strong>
                  <span class="task-points">{{ task.points }} pts</span>
                </header>
                {% if task.description %}
                  <p>{{ task.description }}</p>
                {% endif %}
                <p class="task-meta">Course task</p>
                <form method="post" action="{{ url_for('main.update_task_status', task_id=task.id) }}" class="status-form">
                  {{ status_form.csrf_token }}
                  <label class="sr-only" for="team-status-{{ task.id }}">Status</label>
                  <select id="team-status-{{ task.id }}" name="status">
                    {% for value, label in status_choices %}
                      <option value="{{ value }}" {% if value == task.status %}selected{% endif %}>
                        {{ label }}
                      </option>
                    {% endfor %}
                  </select>
                  <button type="submit">Update</button>
                </form>
                {% if task.comments %}
                  <div class="task-comments">
                    <strong>Feedback</strong>
                    <ul>
                      {% for comment in task.comments %}
                        <li>
                          <span class="comment-author">{{ comment.author.email }}</span>
                          <small>{{ comment.created_at.strftime("%b %d %H:%M") }}</small>
                          <p>{{ comment.body }}</p>
                        </li>
                      {% endfor %}
                    </ul>
                  </div>
                {% endif %}
                {% if current_user.can_review_tasks %}
                  <form method="post" action="{{ url_for('main.add_task_comment', task_id=task.id) }}" class="comment-form">
                    {{ comment_form.csrf_token }}
                    {{ comment_form.body(id='team-comment-body-' ~ task.id, rows=2, placeholder='Leave quick feedback...') }}
                    <button type="submit">Post</button>
                  </form>
                {% endif %}
              </article>
            {% endfor %}
          {% else %}
            <p class="empty-state">No tasks.</p>
          {% endif %}
        </div>
      {% endfor %}
    </div>
  </section>
{% endblock %}
